#!/bin/bash

#===============================================================================
# NOVA ESTATE Admin CLI
# Usage: admin <command> [target] [options]
#===============================================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Project directory
PROJECT_DIR="/var/www/www-root/data/www/admin.novaestate.company"
cd "$PROJECT_DIR" || exit 1

# Helper functions
print_header() {
    echo -e "\n${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}  NOVA ESTATE Admin CLI${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

success() { echo -e "${GREEN}✓ $1${NC}"; }
error() { echo -e "${RED}✗ $1${NC}"; }
info() { echo -e "${BLUE}→ $1${NC}"; }
warn() { echo -e "${YELLOW}! $1${NC}"; }

#===============================================================================
# COMMANDS
#===============================================================================

cmd_help() {
    print_header
    echo -e "${YELLOW}Usage:${NC} admin <command> [target] [options]\n"

    echo -e "${CYAN}Run Commands:${NC}"
    echo "  admin run                   Start all (backend + frontend)"
    echo "  admin run backend           Start backend only"
    echo "  admin run frontend          Start frontend only"
    echo "  admin run dev               Start all in dev mode"
    echo "  admin run dev backend       Start backend in dev mode"
    echo "  admin run dev frontend      Start frontend in dev mode"

    echo -e "\n${CYAN}Stop Commands:${NC}"
    echo "  admin stop                  Stop all"
    echo "  admin stop backend          Stop backend"
    echo "  admin stop frontend         Stop frontend"

    echo -e "\n${CYAN}Restart Commands:${NC}"
    echo "  admin restart               Restart all"
    echo "  admin restart backend       Restart backend"
    echo "  admin restart frontend      Restart frontend"

    echo -e "\n${CYAN}Build Commands:${NC}"
    echo "  admin build                 Build all"
    echo "  admin build backend         Build backend only"
    echo "  admin build frontend        Build frontend only"

    echo -e "\n${CYAN}Install Commands:${NC}"
    echo "  admin install               Install all dependencies"
    echo "  admin install backend       Install backend dependencies"
    echo "  admin install frontend      Install frontend dependencies"

    echo -e "\n${CYAN}Logs Commands:${NC}"
    echo "  admin logs                  Show all logs"
    echo "  admin logs backend          Show backend logs"
    echo "  admin logs frontend         Show frontend logs"
    echo "  admin logs clear            Clear all logs"

    echo -e "\n${CYAN}Status Commands:${NC}"
    echo "  admin status                Show PM2 status"
    echo "  admin monit                 Open PM2 monitor"

    echo -e "\n${CYAN}Git Commands:${NC}"
    echo "  admin pull                  Git pull from origin"
    echo "  admin push                  Git push to origin"
    echo "  admin status git            Git status"
    echo "  admin diff                  Git diff"
    echo "  admin log                   Git log (last 20)"
    echo "  admin stash                 Git stash"
    echo "  admin stash pop             Git stash pop"

    echo -e "\n${CYAN}Database Commands:${NC}"
    echo "  admin migrate               Run database migrations"
    echo "  admin seed                  Run database seeders"

    echo -e "\n${CYAN}Deploy Commands:${NC}"
    echo "  admin deploy                Full deploy (pull + build + restart)"
    echo "  admin deploy backend        Deploy backend only"
    echo "  admin deploy frontend       Deploy frontend only"
    echo "  admin deploy quick          Quick deploy (pull + restart)"

    echo -e "\n${CYAN}Utility Commands:${NC}"
    echo "  admin clean                 Clean node_modules and dist"
    echo "  admin health                Check backend health"
    echo ""
}

# RUN commands
cmd_run() {
    local target="${1:-all}"
    local mode="${2:-prod}"

    case "$target" in
        dev)
            # admin run dev [backend|frontend]
            local dev_target="${2:-all}"
            case "$dev_target" in
                backend)
                    info "Starting backend in dev mode..."
                    pm2 start ecosystem.config.js --only nova-backend-dev
                    success "Backend dev started"
                    ;;
                frontend)
                    info "Starting frontend in dev mode..."
                    pm2 start ecosystem.config.js --only nova-frontend-dev
                    success "Frontend dev started"
                    ;;
                *)
                    info "Starting all in dev mode..."
                    pm2 start ecosystem.config.js --only nova-backend-dev,nova-frontend-dev
                    success "All dev services started"
                    ;;
            esac
            ;;
        backend)
            info "Starting backend..."
            pm2 start ecosystem.config.js --only nova-backend
            success "Backend started"
            ;;
        frontend)
            info "Starting frontend..."
            pm2 start ecosystem.config.js --only nova-frontend
            success "Frontend started"
            ;;
        all|*)
            info "Starting all services..."
            pm2 start ecosystem.config.js --only nova-backend,nova-frontend
            success "All services started"
            ;;
    esac
    pm2 save
}

# STOP commands
cmd_stop() {
    local target="${1:-all}"

    case "$target" in
        backend)
            info "Stopping backend..."
            pm2 stop nova-backend nova-backend-dev 2>/dev/null
            success "Backend stopped"
            ;;
        frontend)
            info "Stopping frontend..."
            pm2 stop nova-frontend nova-frontend-dev 2>/dev/null
            success "Frontend stopped"
            ;;
        all|*)
            info "Stopping all services..."
            pm2 stop nova-backend nova-frontend nova-backend-dev nova-frontend-dev 2>/dev/null
            success "All services stopped"
            ;;
    esac
}

# RESTART commands
cmd_restart() {
    local target="${1:-all}"

    case "$target" in
        backend)
            info "Restarting backend..."
            pm2 restart nova-backend 2>/dev/null || pm2 restart nova-backend-dev 2>/dev/null
            success "Backend restarted"
            ;;
        frontend)
            info "Restarting frontend..."
            pm2 restart nova-frontend 2>/dev/null || pm2 restart nova-frontend-dev 2>/dev/null
            success "Frontend restarted"
            ;;
        all|*)
            info "Restarting all services..."
            pm2 restart all
            success "All services restarted"
            ;;
    esac
}

# BUILD commands
cmd_build() {
    local target="${1:-all}"

    case "$target" in
        backend)
            info "Building backend..."
            cd "$PROJECT_DIR/backend" && npm run build
            success "Backend built"
            ;;
        frontend)
            info "Building frontend..."
            cd "$PROJECT_DIR/frontend" && npm run build
            success "Frontend built"
            ;;
        all|*)
            info "Building all..."
            cd "$PROJECT_DIR/backend" && npm run build
            cd "$PROJECT_DIR/frontend" && npm run build
            success "All built"
            ;;
    esac
}

# INSTALL commands
cmd_install() {
    local target="${1:-all}"

    case "$target" in
        backend)
            info "Installing backend dependencies..."
            cd "$PROJECT_DIR/backend" && npm install
            success "Backend dependencies installed"
            ;;
        frontend)
            info "Installing frontend dependencies..."
            cd "$PROJECT_DIR/frontend" && npm install
            success "Frontend dependencies installed"
            ;;
        all|*)
            info "Installing all dependencies..."
            cd "$PROJECT_DIR/backend" && npm install
            cd "$PROJECT_DIR/frontend" && npm install
            success "All dependencies installed"
            ;;
    esac
}

# LOGS commands
cmd_logs() {
    local target="${1:-all}"

    case "$target" in
        backend)
            pm2 logs nova-backend --lines 100
            ;;
        frontend)
            pm2 logs nova-frontend --lines 100
            ;;
        clear)
            pm2 flush
            success "Logs cleared"
            ;;
        all|*)
            pm2 logs --lines 50
            ;;
    esac
}

# STATUS command
cmd_status() {
    local target="${1:-pm2}"

    case "$target" in
        git)
            git status
            ;;
        *)
            pm2 status
            ;;
    esac
}

# DEPLOY commands
cmd_deploy() {
    local target="${1:-all}"

    case "$target" in
        backend)
            info "Deploying backend..."
            git pull origin main
            cd "$PROJECT_DIR/backend" && npm run build
            pm2 restart nova-backend 2>/dev/null
            success "Backend deployed"
            ;;
        frontend)
            info "Deploying frontend..."
            git pull origin main
            cd "$PROJECT_DIR/frontend" && npm run build
            pm2 restart nova-frontend 2>/dev/null
            success "Frontend deployed"
            ;;
        quick)
            info "Quick deploy (no build)..."
            git pull origin main
            pm2 restart all
            success "Quick deploy complete"
            ;;
        all|*)
            info "Full deploy..."
            git pull origin main
            cmd_build all
            pm2 restart all
            success "Full deploy complete"
            ;;
    esac
}

# GIT commands
cmd_pull() {
    info "Pulling from origin..."
    git pull origin main
    success "Pull complete"
}

cmd_push() {
    info "Pushing to origin..."
    git push origin main
    success "Push complete"
}

cmd_diff() {
    git diff
}

cmd_log() {
    git log --oneline -20
}

cmd_stash() {
    local action="${1:-save}"

    case "$action" in
        pop)
            git stash pop
            ;;
        *)
            git stash
            ;;
    esac
}

# DATABASE commands
cmd_migrate() {
    info "Running migrations..."
    cd "$PROJECT_DIR/backend" && npm run migrate
    success "Migrations complete"
}

cmd_seed() {
    info "Running seeders..."
    cd "$PROJECT_DIR/backend" && npm run seed
    success "Seeding complete"
}

# UTILITY commands
cmd_clean() {
    info "Cleaning project..."
    rm -rf "$PROJECT_DIR/backend/node_modules"
    rm -rf "$PROJECT_DIR/frontend/node_modules"
    rm -rf "$PROJECT_DIR/backend/dist"
    rm -rf "$PROJECT_DIR/frontend/dist"
    rm -rf "$PROJECT_DIR/logs/*.log"
    success "Project cleaned"
}

cmd_health() {
    info "Checking backend health..."
    curl -s http://localhost:9991/api/health || echo "Backend not responding"
}

cmd_monit() {
    pm2 monit
}

#===============================================================================
# MAIN
#===============================================================================

command="${1:-help}"
shift 2>/dev/null

case "$command" in
    run)        cmd_run "$@" ;;
    stop)       cmd_stop "$@" ;;
    restart)    cmd_restart "$@" ;;
    build)      cmd_build "$@" ;;
    install)    cmd_install "$@" ;;
    logs)       cmd_logs "$@" ;;
    status)     cmd_status "$@" ;;
    deploy)     cmd_deploy "$@" ;;
    pull)       cmd_pull ;;
    push)       cmd_push ;;
    diff)       cmd_diff ;;
    log)        cmd_log ;;
    stash)      cmd_stash "$@" ;;
    migrate)    cmd_migrate ;;
    seed)       cmd_seed ;;
    clean)      cmd_clean ;;
    health)     cmd_health ;;
    monit)      cmd_monit ;;
    help|--help|-h|*)
        cmd_help
        ;;
esac
